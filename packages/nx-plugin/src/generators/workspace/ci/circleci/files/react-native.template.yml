# This file is a template. A main CI configuration will be generated by
# chiubaka/dynamic-setup based on this file iff React Native projects are
# detected in this Nx monorepo.
# Environment variables in this file will be replaced dynamically using the
# `envsubst` command.
# Pipeline parameters will also be supplied by the dynamic-setup task.
# The following variables will be provided:
#   - IOS_SEMVER_REGEX: A regular expression matching the pattern for a tag
#     for any of the iOS-enabled React Native projects in this monorepo. To
#     be used for tag-based filtering e.g. for deployment jobs.
#   - ANDROID_SEMVER_REGEX: A regular expression matching the pattern for a
#     tag for any of the Android-enabled Rect Native projects in this monorepo.
#     To be used for tag-based filtering e.g. for deployment jobs.
#   - SETUP_IOS_APPS_STEPS: Steps to run to set up all of the iOS projects in
#     this monorepo. The dynamic configuration will fill this in based on affected
#     projects only. This should be used in combination with the ios-job-params
#     YAML alias.
#   - SETUP_ANDROID_APPS_STEPS: Steps to run to set up all of the Android projects
#     in this monorepo. The dynamic configuration will fill this in based on affected
#     projects only. This should be used in combination with the android-job-params
#     YAML alias.
#
# You may safely customize this file!! However, this configuration is designed to
# work out of the box for most typical usecases.

%YAML 1.1
---
version: 2.1

constants:
  # Semantic versioning RegEx modified from https://semver.org/#is-there-a-suggested-regular-expression-regex-to-check-a-semver-string
  semver-regex: &semver-regex /^(\w+-)+v(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?$/
  ios-semver-regex: &ios-semver-regex $IOS_SEMVER_REGEX
  android-semver-regex: &android-semver-regex $ANDROID_SEMVER_REGEX
  ios-job-params: &ios-job-params
    context:
      - ios-deployment
    xcode-version: << pipeline.parameters.xcode-version >>
    simulator-device: << pipeline.parameters.ios-simulator-device >>
    simulator-version: << pipeline.parameters.ios-simulator-version >>
    setup-apps-steps: $SETUP_IOS_APPS_STEPS
  android-job-params: &android-job-params
    build-tools-version: << pipeline.parameters.android-emulator-build-tools-version >>
    platform-version: << pipeline.parameters.android-emulator-platform-version >>
    setup-apps-steps: $SETUP_ANDROID_APPS_STEPS

orbs:
  chiubaka: chiubaka/circleci-orb@dev:alpha

parameters:
  xcode-version:
    description: The version of Xcode to use with for macOS executors
    type: string
    default: 14.3.1
  ios-simulator-device:
    description: The iOS device to use for the simulator when required
    type: string
    default: iPhone 14
  ios-simulator-version:
    description: The OS version to use for the simulator when required
    type: string
    default: "16.4"
  android-emulator-build-tools-version:
    description: The build tools version to use for the Android emulator when required
    type: string
    default: 34.0.0
  android-emulator-platform-version:
    description: The platform version to use for the Android emulator when required
    default: android-34
  build-ios:
    description: Whether or not to enable the build-ios job
    type: boolean
    default: false
  build-android:
    description: Whether or not to enable the build-android job
    type: boolean
    default: false
  test-ios:
    description: Whether or not to enable the test-ios job
    type: boolean
    default: false
  test-android:
    description: Whether or not to enable the test-android job
    type: boolean
    default: false
  e2e-ios:
    description: Whether or not to enable the e2e-ios job
    type: boolean
    default: false
  e2e-android:
    description: Whether or not to enable the e2e-android job
    type: boolean
    default: false

filters:
  semver-tags: &semver-tags
    tags:
      only: *semver-regex
  android-semver-tags: &android-semver-tags
    tags:
      only: *android-semver-regex
  ios-semver-tags: &ios-semver-tags
    tags:
      only: *ios-semver-regex
  ignore-android-semver-tags: &ignore-android-semver-tags
    tags:
      ignore: *android-semver-regex
  ignore-ios-semver-tags: &ignore-ios-semver-tags
    tags:
      ignore: *ios-semver-regex
  ignore-branches: &ignore-branches
    branches:
      ignore: /.*/

workflows:
  lint-build-test-e2e-deploy:
    jobs:
      - chiubaka/lint:
          name: lint
          filters:
            <<: *semver-tags
      - chiubaka/build:
          name: build
          filters:
            <<: *semver-tags
      - chiubaka/test:
          name: test
          filters:
            <<: *semver-tags
      - chiubaka/e2e:
          name: e2e
          requires:
            - build
          filters:
            <<: *semver-tags
      - chiubaka/deploy:
          name: deploy
          requires:
            - build
            - test
            - e2e
          filters:
            <<: *ignore-branches
            <<: *ignore-android-semver-tags
            <<: *ignore-ios-semver-tags
            <<: *semver-tags
      - chiubaka/build-android:
          name: build-android
          enabled: << pipeline.parameters.build-android >>
          <<: *android-job-params
          requires:
            - build
          filters:
            <<: *android-semver-tags
            <<: *ios-semver-tags
      - chiubaka/build-ios:
          name: build-ios
          enabled: << pipeline.parameters.build-ios >>
          <<: *ios-job-params
          requires:
            - build
          filters:
            <<: *android-semver-tags
            <<: *ios-semver-tags
      - chiubaka/test-android:
          name: test-android
          enabled: << pipeline.parameters.test-android >>
          <<: *android-job-params
          requires:
            - build
            - build-android
            - test
            - e2e
          filters:
            <<: *android-semver-tags
            <<: *ios-semver-tags
      - chiubaka/test-ios:
          name: test-ios
          enabled: << pipeline.parameters.test-ios >>
          <<: *ios-job-params
          requires:
            - build
            - build-ios
            - test
            - e2e
          filters:
            <<: *android-semver-tags
            <<: *ios-semver-tags
      - chiubaka/e2e-android:
          name: e2e-android
          enabled: << pipeline.parameters.e2e-android >>
          <<: *android-job-params
          requires:
            - build-android
            - test-android
          filters:
            <<: *android-semver-tags
            <<: *ios-semver-tags
      - chiubaka/e2e-ios:
          name: e2e-ios
          enabled: << pipeline.parameters.e2e-ios >>
          <<: *ios-job-params
          requires:
            - build-ios
            - test-ios
          filters:
            <<: *android-semver-tags
            <<: *ios-semver-tags
      - chiubaka/deploy-android:
          name: deploy-android
          <<: *android-job-params
          requires:
            - e2e-android
          filters:
            <<: *ignore-branches
            <<: *android-semver-tags
      - chiubaka/deploy-ios:
          name: deploy-ios
          <<: *ios-job-params
          requires:
            - e2e-ios
          filters:
            <<: *ignore-branches
            <<: *ios-semver-tags
